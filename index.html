const API="https://test-be375-default-rtdb.europe-west1.firebasedatabase.app";

// ===================== EMOTES =====================
let EMOTES = { global:{}, channels:{} };

async function loadEmotes(){
  try{
    // Global
    const rGlobal = await fetch(`${API}/emotes/global.json`);
    EMOTES.global = await rGlobal.json() || {};

    // Kanały
    const rChannels = await fetch(`${API}/emotes/channels.json`);
    EMOTES.channels = await rChannels.json() || {};

    renderEmoteList();
  }catch(e){
    console.error("Błąd wczytywania emotes:", e);
  }
}

function renderEmoteList(){
  const list = document.getElementById("emoteList");
  list.innerHTML = "";

  // Globalne
  for(const key in EMOTES.global){
    appendEmote(list,key,EMOTES.global[key],"global");
  }

  // Kanałowe
  for(const ch in EMOTES.channels){
    for(const key in EMOTES.channels[ch]){
      appendEmote(list,key,EMOTES.channels[ch][key],ch);
    }
  }
}

function appendEmote(list,key,e,ch){
  const d=document.createElement("div");
  d.className="emote";
  d.innerHTML = `
    <img src="${e.url}">
    <div><b>${key}</b></div>
    <small>${e.author||""}${ch!=="global"?" | "+ch:""}</small>
    <button class="delete">X</button>
  `;
  d.querySelector(".delete").onclick = async ()=>{
    const path = ch==="global"?`/emotes/global/${key}.json`:`/emotes/channels/${ch}/${key}.json`;
    await fetch(API+path,{method:"DELETE"});
    loadEmotes();
  };
  list.appendChild(d);
}

// Dodawanie emotki
document.getElementById("addEmote").onclick=async()=>{
  const trigger = document.getElementById("emoteTrigger").value.trim();
  const author  = document.getElementById("emoteAuthor").value.trim();
  const url     = document.getElementById("emoteUrl").value.trim();
  const scope   = document.querySelector('input[name="scope"]:checked')?.value || "global";
  const channel = document.getElementById("emoteChannel")?.value.trim();

  if(!trigger || !url) return alert("Trigger i URL wymagane");

  if(scope==="global"){
    await fetch(`${API}/emotes/global/${trigger}.json`,{
      method:"PUT",
      body:JSON.stringify({url,author})
    });
  }else{
    if(!channel) return alert("Podaj kanał");
    await fetch(`${API}/emotes/channels/${channel}/${trigger}.json`,{
      method:"PUT",
      body:JSON.stringify({url,author})
    });
  }
  loadEmotes();
}

// ===================== REPLACE EMOTES W CHAT =====================
function replaceEmotes(msg, channel="global"){
  if(msg.dataset.emotesDone) return;

  let html = msg.innerHTML;
  let changed = false;

  const allEmotes = {...EMOTES.global};
  if(channel && EMOTES.channels[channel]){
    Object.assign(allEmotes, EMOTES.channels[channel]);
  }

  for(const name in allEmotes){
    const url = allEmotes[name].url;
    const safe = name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
    const re = new RegExp(`(^|\\s)${safe}(?=\\s|$)`,"gi");
    html = html.replace(re,(m,p1)=>`${p1}<img class="emote-img" src="${url}" alt="${name}">`);
    changed = true;
  }

  if(changed){
    msg.innerHTML = html;
    msg.dataset.emotesDone = "1";
  }
}

// ===================== SCAN CHAT =====================
function scan(){
  document.querySelectorAll('span[data-a-target="chat-message-username"]').forEach(paintNick);
  document.querySelectorAll('span[data-a-target="chat-message-text"]').forEach(msg=>{
    const channel = msg.closest('[data-channel]')?.dataset.channel || "global";
    replaceEmotes(msg, channel);
  });
}

// ===================== OBSERVER =====================
const observer = new MutationObserver(mutations=>{
  mutations.forEach(m=>{
    m.addedNodes.forEach(n=>{
      if(n.nodeType!==1) return;
      const nick = n.querySelector?.('span[data-a-target="chat-message-username"]');
      if(nick) paintNick(nick);
      const msg = n.querySelector?.('span[data-a-target="chat-message-text"]');
      if(msg){
        const channel = n.dataset.channel || "global";
        replaceEmotes(msg, channel);
      }
    });
  });
});

// ===================== INIT =====================
const wait = setInterval(()=>{
  const chat = document.querySelector('[role="log"]');
  if(chat){
    observer.observe(chat,{childList:true,subtree:true});
    scan();
    clearInterval(wait);
  }
},200);

setInterval(scan,1500);
loadEmotes();

