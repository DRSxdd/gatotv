<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gato.TV Panel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&family=Permanent+Marker&family=Courier+Prime&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    :root { --bg: #0b1120; --panel: #1e293b; --accent: #38bdf8; --twitch: #9146ff; --yellow: #facc15; --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155; --danger: #ef4444; --success: #22c55e; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Outfit', sans-serif; background: radial-gradient(circle at top, #172554, var(--bg)); color: var(--text); min-height: 100vh; padding-bottom: 50px; overflow-x: hidden; }

    /* HEADER */
    header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 30px rgba(0,0,0,0.3); }
    .header-left { display: flex; align-items: center; gap: 20px; flex: 1; }
    .logo { font-size: 26px; font-weight: 900; color: var(--accent); letter-spacing: -1px; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
    .beta-tag { font-size: 10px; background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }

    .btn-login-header { background: var(--twitch); color: white; border: none; padding: 8px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 0 15px rgba(145, 70, 255, 0.2); }
    .btn-login-header:hover { background: #772ce8; transform: translateY(-1px); }

    .coin-display { display: none; align-items: center; gap: 8px; background: rgba(250, 204, 21, 0.1); border: 1px solid var(--yellow); color: var(--yellow); padding: 6px 14px; border-radius: 10px; font-weight: 800; font-size: 14px; margin-right: 20px; }
    .coin-display i { font-size: 16px; filter: drop-shadow(0 0 5px rgba(250,204,21,0.6)); }

    .search-container { position: relative; width: 260px; }
    .search-input { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 9px 15px 9px 40px; border-radius: 50px; font-family: 'Outfit', sans-serif; font-size: 13px; outline: none; transition: 0.2s; }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(56, 189, 248, 0.2); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px; pointer-events: none; }

    nav { display: flex; gap: 5px; background: #0f172a; padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
    nav button { background: none; border: none; color: var(--text-muted); font-size: 13px; font-weight: 600; padding: 8px 16px; cursor: pointer; border-radius: 6px; transition: 0.2s; }
    nav button:hover { color: #fff; background: rgba(255,255,255,0.05); }
    nav button.active { background: var(--accent); color: #0b1120; font-weight: 800; box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
    nav button.btn-purple.active { background: var(--twitch); color: white; box-shadow: 0 0 15px rgba(145, 70, 255, 0.4); }
    nav button.btn-yellow.active { background: var(--yellow); color: black; box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); }

    /* CONTENT */
    .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    .panel { display: none; animation: fadeIn 0.3s ease-out; }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .login-blocker { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 20px; background: var(--panel); border: 1px solid var(--border); border-radius: 16px; margin-top: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; }
    .login-blocker h2 { font-size: 28px; margin-bottom: 10px; color: white; }
    
    /* FLOATING PROFILE (FIXED BOTTOM LEFT) */
    .floater-wrapper { position: fixed; bottom: 20px; left: 20px; z-index: 900; display: none; flex-direction: column; gap: 10px; }
    .role-badge { align-self: flex-start; margin-left: 5px; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .role-user { border-color: var(--success); color: var(--success); }
    .role-admin { border-color: var(--danger); color: var(--danger); }
    
    .user-card-mini { display: flex; align-items: center; gap: 12px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border); padding: 10px 15px 10px 10px; border-radius: 50px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.2s; }
    .user-card-mini:hover { transform: translateY(-2px); border-color: var(--accent); }
    .mini-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--twitch); }
    .mini-info { display: flex; flex-direction: column; line-height: 1.2; }
    .mini-name { font-weight: 700; color: white; font-size: 14px; }
    .btn-logout { background: none; border: none; color: var(--text-muted); font-size: 11px; cursor: pointer; padding: 0; text-align: left; font-weight: 600; }
    .btn-logout:hover { color: var(--danger); }

    /* PROFILE UI */
    .profile-header { position: relative; margin-bottom: 20px; background: #131c2e; border: 1px solid var(--border); border-radius: 20px; overflow: hidden; margin-top: 20px; }
    .profile-banner { height: 180px; background: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2072&auto=format&fit=crop') center/cover; position: relative; }
    .profile-banner::after { content:''; position: absolute; bottom:0; left:0; width:100%; height:100%; background: linear-gradient(to top, #131c2e 0%, transparent 80%); }
    .profile-meta { display: flex; align-items: flex-end; padding: 0 40px 20px 40px; position: relative; top: -40px; margin-bottom: -40px; }
    .profile-avatar { width: 110px; height: 110px; border-radius: 50%; border: 5px solid #131c2e; background: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 2; flex-shrink: 0; }
    .profile-details { margin-left: 20px; margin-bottom: 45px; z-index: 2; flex: 1; }
    .profile-name { font-size: 28px; font-weight: 900; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.8); line-height: 1.2; display: flex; align-items: center; gap: 10px; }
    .viewing-tag { font-size: 10px; background: var(--yellow); color: black; padding: 2px 8px; border-radius: 20px; vertical-align: middle; }
    .profile-subnav { display: flex; gap: 10px; margin-bottom: 20px; margin-left: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    .profile-subnav button { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); font-size: 13px; font-weight: 700; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: 0.2s; }
    .profile-subnav button.active { background: var(--twitch); color: white; border-color: var(--twitch); }
    .back-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 10; display: none; }
    
    /* PREVIEW & GRID */
    .chat-preview { background: #18181b; border: 1px solid #333; border-radius: 12px; padding: 15px 20px; margin-bottom: 30px; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: space-between; }
    .chat-line { display: flex; align-items: center; font-size: 13px; }
    .preview-nick { font-weight: 700; color: #00ff00; margin-right: 5px; }
    .preview-msg { color: #efeff1; }
    
    .grid-box { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .item-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 6px; cursor: pointer; text-align: center; transition: 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
    .item-card:hover { border-color: var(--text-muted); transform: translateY(-3px); }
    .item-card.owned { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
    .card-vis { padding: 30px 10px; font-size: 20px; font-weight: 900; display:flex; align-items:center; justify-content:center; height: 100px; }
    .card-data { background: #131c2e; padding: 12px; border-radius: 0 0 8px 8px; display: flex; flex-direction: column; gap: 8px; flex: 1; justify-content: flex-end; }
    .card-name { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .action-btn { width: 100%; padding: 8px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 11px; text-transform: uppercase; }
    .btn-buy { background: var(--yellow); color: #000; }
    .btn-equip { background: var(--success); color: #fff; }
    .btn-unequip { background: var(--danger); color: #fff; }

    /* EMOTES */
    .emote-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 20px; }
    .emote-box { background: #131c2e; border: 1px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-height: 120px; justify-content: center; transition: 0.2s; }
    .emote-box:hover { border-color: var(--accent); transform: translateY(-3px); }
    .emote-box img { height: 48px; width: auto; object-fit: contain; margin-bottom: 10px; }
    .emote-name { font-weight: 700; font-size: 12px; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }

    /* MODAL (FIXED POSITION) */
    .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: #1e293b; border: 1px solid var(--border); width: 90%; max-width: 400px; border-radius: 20px; overflow: hidden; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-head { background: #0f172a; padding: 30px; text-align: center; border-bottom: 1px solid var(--border); position: relative; }
    .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
    .modal-content { padding: 30px; text-align: center; }
    .modal-btn { width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
    
    /* UTILS */
    .btn-daily { margin-left: auto; background: linear-gradient(45deg, #facc15, #f59e0b); color: #000; border: none; border-radius: 50px; padding: 6px 16px; font-size: 12px; font-weight: 900; cursor: pointer; box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); display: flex; align-items: center; gap: 6px; }
    .btn-daily:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; box-shadow: none; }
    .redeem-btn { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, #ef4444, #f43f5e); color: white; padding: 12px 24px; border-radius: 50px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2); z-index: 999; display: flex; align-items: center; gap: 10px; }
    
    .hidden { display: none !important; }
</style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="logo">Gato.TV <span class="beta-tag">BETA</span></div>
        <div id="loginArea">
            <button class="btn-login-header" onclick="authTwitch()">Zaloguj</button>
        </div>
        <div class="search-container" id="searchArea" style="display:none;">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Szukaj profilu...">
        </div>
    </div>
    <div style="display:flex; align-items:center;">
        <div id="coinArea" class="coin-display">
            <i class="fas fa-coins"></i> <span id="coinVal">0</span>
        </div>
        <nav>
            <button class="active" onclick="nav('profile')">Profile</button>
            <button onclick="nav('shop')">Shop</button>
            <button onclick="nav('emotes')">Emotes</button>
            <button class="btn-purple" onclick="nav('premium')">Premium</button>
            <button class="btn-yellow" onclick="nav('download')">Download</button>
        </nav>
    </div>
</header>

<div class="container">

    <!-- TAB: PROFILE -->
    <div id="tab_profile" class="panel active">
        <div class="login-blocker"><h2> Zaloguj si</h2><button class="btn-login-header" onclick="authTwitch()">Zaloguj z Twitch</button></div>
        <div class="protected-content">
            <div class="profile-header">
                <button id="backBtn" class="back-btn" onclick="exitViewMode()">WR DO SIEBIE</button>
                <div class="profile-banner"></div>
                <div class="profile-meta">
                    <img id="profAva" class="profile-avatar" src="">
                    <div class="profile-details">
                        <div class="profile-name">
                            <span id="profName">...</span> 
                            <span id="viewTag" class="viewing-tag" style="display:none;">PODGLD</span>
                        </div>
                        <span id="profRole" style="font-size:11px; font-weight:700; color:#38bdf8;">USER</span>
                    </div>
                    <div class="profile-subnav">
                        <button id="subInv" class="active" onclick="subNav('inv')">Ekwipunek</button>
                        <button id="subUp" onclick="subNav('up')">Uploaded</button>
                        <button id="subCh" onclick="subNav('ch')">Channel</button>
                    </div>
                </div>
            </div>
            
            <div class="profile-content-area">
                <!-- PREVIEW -->
                <div class="chat-preview">
                    <div class="chat-line">
                        <span class="preview-nick" id="previewUser">Nick</span>:
                        <span class="preview-msg">Gato.TV zmienia Tw贸j czat! </span>
                    </div>
                </div>
                
                <div id="view_inv" style="display:block;">
                    <div id="gridInv" class="grid-box"></div>
                </div>
                <div id="view_up" style="display:none;">
                    <div id="gridUp" class="emote-grid"></div>
                </div>
                <div id="view_ch" style="display:none;">
                    <div id="gridCh" class="emote-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: SHOP -->
    <div id="tab_shop" class="panel">
        <div class="protected-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Sklep Gato.TV</h2>
                <button id="btnBonus" class="btn-daily" onclick="getDaily()"> ODBIERZ +10</button>
            </div>
            <div id="gridShop" class="grid-box"></div>
        </div>
    </div>

    <!-- TAB: EMOTES -->
    <div id="tab_emotes" class="panel">
        <div class="login-blocker"><h2> Zaloguj si</h2><button class="btn-login-header" onclick="authTwitch()">Zaloguj z Twitch</button></div>
        <div class="protected-content">
            <div class="emote-sub-nav">
                <button id="eTabGlobal" class="active" onclick="emoteTab('global')">GLOBAL</button>
                <button id="eTabUsers" onclick="emoteTab('users')">USERS</button>
            </div>
            <div id="gridEmotes" class="emote-grid">adowanie...</div>
        </div>
    </div>

    <!-- TAB: PREMIUM -->
    <div id="tab_premium" class="panel">
        <div class="login-blocker"><h2>Dostpne wkr贸tce</h2></div>
    </div>

    <!-- TAB: DOWNLOAD -->
    <div id="tab_download" class="panel">
        <div class="login-blocker"><h2>Dostpne wkr贸tce</h2></div>
    </div>

</div>

<!-- FIXED BOTTOM ELEMENTS -->
<div class="floater-wrapper" id="floater" style="display:none;">
    <div id="badgeRole" class="role-badge role-user">USER</div>
    <div class="user-card-mini">
        <img id="miniAva" class="mini-avatar" src="">
        <div class="mini-info">
            <span id="miniName" class="mini-name">...</span>
            <button class="btn-logout" onclick="doLogout()">Wyloguj</button>
        </div>
    </div>
</div>

<div class="redeem-btn" onclick="redeemCode()"> REDEEM CODE</div>

<!-- MODAL (HIDDEN) -->
<div id="modalWrap" class="modal-wrap" style="display:none;">
    <div class="modal-box">
        <div class="modal-head">
            <button class="modal-close" onclick="closeModal()"></button>
            <img id="mImg" src="" style="height:80px;">
        </div>
        <div class="modal-content">
            <h2 id="mCode" style="color:white; margin:0;">CODE</h2>
            <p id="mAuth" style="color:#888; font-size:12px;">Author</p>
            <button class="modal-btn" style="background:#22c55e; color:#fff;" onclick="assignEmote()">PRZYPISZ DO KANAU</button>
        </div>
    </div>
</div>

<script>
// CONFIG
const CLIENT_ID = 'l0agnxl8yeto7wda5wvblpg1mr55db';
const REDIRECT = window.location.origin + window.location.pathname;
const API = "https://test-be375-default-rtdb.europe-west1.firebasedatabase.app";
const ADMINS = ["twoj_nick", "gatojestemformaostateczna"];

// STATE
let User = null;
let Token = null;
let Coins = 100;
let Owned = [];
let Loadout = {};
let Emotes = {};
let Viewing = null;
let Role = 'USER';

// CATALOG
const ITEMS = [
    {id:1, name:"Mana Potion", type:"paint", val:"linear-gradient(90deg, #f0f, #0ff)", price:10, css:"background:linear-gradient(90deg, #f0f, #0ff); -webkit-background-clip:text; color:transparent;"},
    {id:2, name:"Fire Lord", type:"paint", val:"linear-gradient(90deg, #f00, #ff0)", price:50, css:"background:linear-gradient(90deg, #f00, #ff0); -webkit-background-clip:text; color:transparent;"},
    {id:3, name:"Golden", type:"paint", val:"#ffd700", price:100, css:"color:#ffd700; text-shadow:0 0 10px gold;"},
    {id:4, name:"Star Badge", type:"badge", val:"https://cdn-icons-png.flaticon.com/128/1828/1828884.png", price:20, css:""},
    {id:5, name:"Toxic", type:"bg", val:"rgba(0,255,0,0.2)", price:50, css:"background:rgba(0,255,0,0.2);"}
];

// INIT
window.onload = async () => {
    // Load Local
    Coins = parseInt(localStorage.getItem('g_coins')) || 100;
    Owned = JSON.parse(localStorage.getItem('g_owned')) || [];
    renderUI();

    // Check Token
    if(location.hash.includes('access_token')) {
        const t = new URLSearchParams(location.hash.substring(1)).get('access_token');
        if(t) { localStorage.setItem('tw_token', t); location.hash=''; await checkUser(t); }
    } else {
        const t = localStorage.getItem('tw_token');
        if(t) await checkUser(t); else showLogin();
    }
    
    // Load Emotes
    try {
        const res = await fetch(`${API}/emotes.json`);
        Emotes = await res.json() || {};
        renderEmotes('global');
    } catch(e){}
};

// AUTH
function authTwitch() {
    location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT)}&response_type=token&scope=user:read:email`;
}

async function checkUser(t) {
    try {
        const r = await fetch('https://api.twitch.tv/helix/users', { headers: {'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${t}`} });
        const d = await r.json();
        if(d.data && d.data[0]) {
            User = d.data[0];
            Token = t;
            Role = ADMINS.includes(User.login) ? 'ADMIN' : 'USER';
            
            // Load Cloud
            const cloud = await fetch(`${API}/premium/${User.login}.json`).then(r=>r.json());
            if(cloud) Loadout = cloud;
            
            showApp();
        } else throw 1;
    } catch(e) { localStorage.removeItem('tw_token'); showLogin(); }
}

function doLogout() { localStorage.removeItem('tw_token'); location.reload(); }

// UI SWITCHING
function showLogin() {
    document.getElementById('loginBtnContainer').style.display = 'block';
    document.getElementById('searchArea').style.display = 'none';
    document.getElementById('coinDisplay').style.display = 'none';
    document.getElementById('floater').style.display = 'none';
    document.querySelectorAll('.login-blocker').forEach(e=>e.style.display='flex');
    document.querySelectorAll('.protected-content').forEach(e=>e.style.display='none');
}

function showApp() {
    document.getElementById('loginBtnContainer').style.display = 'none';
    document.getElementById('searchArea').style.display = 'block';
    document.getElementById('coinDisplay').style.display = 'flex';
    document.getElementById('floater').style.display = 'flex';
    document.querySelectorAll('.login-blocker').forEach(e=>e.style.display='none');
    document.querySelectorAll('.protected-content').forEach(e=>e.style.display='block');
    
    // Fill Data
    fillProfile(User.display_name, User.profile_image_url, Role);
    document.getElementById('miniAva').src = User.profile_image_url;
    document.getElementById('miniName').innerText = User.display_name;
    document.getElementById('badgeRole').innerText = Role;
    document.getElementById('badgeRole').className = `role-badge role-${Role.toLowerCase()}`;
    
    renderUI();
}

// NAVIGATION
window.nav = function(tab) {
    document.querySelectorAll('.panel').forEach(e => e.classList.remove('active'));
    document.getElementById('tab_'+tab).classList.add('active');
    document.querySelectorAll('nav button').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
    if(tab==='profile') resetProfileView();
}

window.subNav = function(sub) {
    document.getElementById('view_inv').style.display = sub==='inv'?'block':'none';
    document.getElementById('view_up').style.display = sub==='up'?'block':'none';
    document.getElementById('view_ch').style.display = sub==='ch'?'block':'none';
    document.querySelectorAll('.profile-subnav button').forEach(b=>b.classList.remove('active'));
    document.getElementById('sub'+(sub.charAt(0).toUpperCase()+sub.slice(1))).classList.add('active');
}

// PROFILE LOGIC
function fillProfile(name, img, role) {
    document.getElementById('profName').innerText = name;
    document.getElementById('profAva').src = img;
    document.getElementById('profRole').innerText = role;
    document.getElementById('previewUser').innerText = name;
}

function resetProfileView() {
    Viewing = null;
    document.getElementById('backBtn').style.display='none';
    document.getElementById('viewTag').style.display='none';
    fillProfile(User.display_name, User.profile_image_url, Role);
    renderUI();
}

document.getElementById('searchInput').addEventListener('keypress', async (e) => {
    if(e.key === 'Enter') {
        const val = e.target.value.toLowerCase();
        window.nav('profile');
        try {
            const r = await fetch(`https://api.twitch.tv/helix/users?login=${val}`, { headers: {'Client-ID':CLIENT_ID, 'Authorization':`Bearer ${Token}`} });
            const d = await r.json();
            if(d.data && d.data[0]) {
                Viewing = d.data[0];
                fillProfile(Viewing.display_name, Viewing.profile_image_url, "VIEWING");
                document.getElementById('backBtn').style.display='block';
                document.getElementById('viewTag').style.display='inline-block';
                renderUI(); // Re-render inventory with read-only
            } else alert("Nie znaleziono.");
        } catch(e) { alert("Bd API"); }
    }
});

window.exitViewMode = resetProfileView;

// RENDERING
function renderUI() {
    document.getElementById('coinVal').innerText = Coins;
    localStorage.setItem('g_coins', Coins);
    localStorage.setItem('g_owned', JSON.stringify(Owned));

    // Shop
    const shop = document.getElementById('gridShop');
    shop.innerHTML = '';
    ITEMS.forEach(i => {
        if(!Owned.includes(i.name)) shop.appendChild(makeCard(i, 'buy'));
    });

    // Inventory (Profile)
    const inv = document.getElementById('gridInv');
    inv.innerHTML = '';
    const targetOwned = Viewing ? [] : ITEMS.filter(i => Owned.includes(i.name)); // Mock viewing empty for now or fetch from DB
    
    if(targetOwned.length === 0) inv.innerHTML = '<p style="color:#555">Pusto</p>';
    else targetOwned.forEach(i => inv.appendChild(makeCard(i, Viewing ? 'view' : 'equip')));

    // Emotes Lists
    renderEmoteLists();
    updatePreview();
}

function makeCard(item, mode) {
    const d = document.createElement('div');
    d.className = 'item-card';
    if(mode !== 'buy') d.classList.add('owned');
    
    let btn = '';
    if(mode === 'buy') btn = `<button class="action-btn btn-buy" onclick="buy(${item.id})">KUP ${item.price}</button>`;
    if(mode === 'equip') {
        const equipped = (Loadout[item.type] && (Loadout[item.type].value === item.val || Loadout[item.type] === item.val));
        btn = equipped ? `<button class="action-btn btn-unequip" onclick="equip(${item.id}, false)">ZDEJMIJ</button>` 
                       : `<button class="action-btn btn-equip" onclick="equip(${item.id}, true)">ZA呕</button>`;
    }
    if(mode === 'view') btn = `<span style="font-size:10px; color:#888;">POSIADASZ</span>`;

    let view = item.type === 'badge' ? `<img src="${item.val}" style="width:30px">` : `<span style="${item.css}; font-size:20px; font-weight:900;">Aa</span>`;

    d.innerHTML = `
        <div class="card-vis">${view}</div>
        <div class="card-data">
            <div class="card-name">${item.name}</div>
            ${btn}
        </div>
    `;
    return d;
}

// ACTIONS
window.buy = function(id) {
    const item = ITEMS.find(i=>i.id===id);
    if(Coins >= item.price) {
        Coins -= item.price;
        Owned.push(item.name);
        renderUI();
        confetti({particleCount:50, spread:60});
    } else alert("Brak monet");
}

window.equip = async function(id, state) {
    if(Viewing) return;
    const item = ITEMS.find(i=>i.id===id);
    if(state) {
        let payload = item.val;
        if(item.type === 'paint') payload = { type:'gradient', value: item.val }; // Simplified
        Loadout[item.type] = payload;
        await fetch(`${API}/premium/${User.login}/${item.type}.json`, {method:'PUT', body:JSON.stringify(payload)});
    } else {
        delete Loadout[item.type];
        await fetch(`${API}/premium/${User.login}/${item.type}.json`, {method:'DELETE'});
    }
    renderUI();
}

function updatePreview() {
    const u = document.getElementById('previewUser');
    const b = document.getElementById('previewBadges');
    u.style = ""; b.innerHTML = "";
    
    // Use Loadout
    // Simplified paint application
    if(Loadout.paint) u.style = Loadout.paint.value.includes('gradient') ? `background:${Loadout.paint.value}; -webkit-background-clip:text; color:transparent; font-weight:900;` : `color:${Loadout.paint.value}; font-weight:700;`;
    if(Loadout.badge) b.innerHTML = `<img src="${Loadout.badge}" class="gato-badge-preview">`;
}

// EMOTES
window.emoteTab = function(t) {
    document.getElementById('eTabGlobal').classList.toggle('active', t==='global');
    document.getElementById('eTabUsers').classList.toggle('active', t==='users');
    renderEmotes(t);
}

function renderEmotes(scope) {
    const grid = document.getElementById('gridEmotes');
    grid.innerHTML = '';
    Object.keys(Emotes).forEach(k => {
        const e = Emotes[k];
        if( (scope==='global' && e.scope==='global') || (scope==='users' && e.scope!=='global') ) {
            grid.innerHTML += `
                <div class="emote-box" onclick="showModal('${k}')">
                    <img src="${e.url}">
                    <div class="emote-name">${k}</div>
                </div>
            `;
        }
    });
}

function renderEmoteLists() {
    const up = document.getElementById('gridUp');
    const ch = document.getElementById('gridCh');
    up.innerHTML=''; ch.innerHTML='';
    const targetName = Viewing ? Viewing.display_name : User.display_name;
    const targetLogin = Viewing ? Viewing.login : User.login;

    Object.keys(Emotes).forEach(k => {
        const e = Emotes[k];
        if(e.author === targetName) up.innerHTML += `<div class="emote-box"><img src="${e.url}"><div class="emote-name">${k}</div></div>`;
        if(e.channel === targetLogin) ch.innerHTML += `<div class="emote-box"><img src="${e.url}"><div class="emote-name">${k}</div></div>`;
    });
}

// MODAL
let selEmote = null;
window.showModal = function(k) {
    selEmote = k;
    const e = Emotes[k];
    document.getElementById('mImg').src = e.url;
    document.getElementById('mCode').innerText = k;
    document.getElementById('mAuth').innerText = "By " + (e.author || '?');
    document.getElementById('modalWrap').style.display = 'flex';
}
window.closeModal = function() { document.getElementById('modalWrap').style.display='none'; }
window.assignEmote = async function() {
    if(!selEmote) return;
    const e = Emotes[selEmote];
    await fetch(`${API}/emotes/${selEmote}.json`, {method:'PUT', body:JSON.stringify({
        url: e.url, author: e.author, scope: 'channel', channel: User.login
    })});
    alert("Przypisano!");
    closeModal();
}

// DAILY
window.getDaily = function() {
    const last = localStorage.getItem('last_daily');
    if(last && Date.now() - last < 86400000) return alert("Wr贸 jutro!");
    Coins += 10;
    localStorage.setItem('last_daily', Date.now());
    renderUI();
    confetti({particleCount:100, spread:70});
}
window.redeemCode = function() {
    const c = prompt("Kod:");
    if(c === 'GATO2025') { Coins += 1000; renderUI(); alert("OK!"); }
}

</script>
</body>
</html>
